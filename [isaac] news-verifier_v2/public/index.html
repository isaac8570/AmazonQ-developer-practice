<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FactCheck AI - 뉴스 검증 플랫폼</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff006e, #00ffff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .search-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .search-box {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        #newsQuery {
            flex: 1;
            padding: 15px 20px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 16px;
        }

        #verifyBtn {
            padding: 15px 30px;
            background: linear-gradient(45deg, #ff006e, #8338ec);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        #verifyBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 0, 110, 0.3);
        }

        .results-container {
            display: none;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        .result-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .card-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
            color: #00ffff;
        }

        .credibility-score {
            text-align: center;
            margin-bottom: 30px;
        }

        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            background: conic-gradient(from 0deg, #ff4444, #ffaa00, #00ff88);
        }

        .mindmap-svg {
            width: 100%;
            height: 500px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .timeline-container {
            width: 100%;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .timeline-container::-webkit-scrollbar {
            width: 8px;
        }

        .timeline-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .timeline-container::-webkit-scrollbar-thumb {
            background: #ff006e;
            border-radius: 4px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            overflow: hidden;
        }

        th {
            padding: 15px;
            background: #ff006e;
            color: white;
            font-weight: bold;
            text-align: left;
        }

        td {
            padding: 12px 15px;
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .news-list {
            margin-top: 20px;
        }

        .news-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .news-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }

        .news-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .news-meta {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
        }

        .error {
            background: rgba(255, 68, 68, 0.2);
            border: 1px solid #ff4444;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .filter-btn {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .filter-btn.active {
            background: #ff006e;
            border-color: #ff006e;
            box-shadow: 0 0 10px rgba(255, 0, 110, 0.5);
        }

        .zoom-controls {
            pointer-events: all;
        }

        .zoom-controls g:hover circle {
            opacity: 0.9;
            transform: scale(1.1);
            transition: all 0.2s ease;
        }

        .instructions {
            pointer-events: none;
        }

        #newsContainer::-webkit-scrollbar {
            width: 6px;
        }

        #newsContainer::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        #newsContainer::-webkit-scrollbar-thumb {
            background: #ff006e;
            border-radius: 3px;
        }

        @media (max-width: 768px) {
            .results-container {
                grid-template-columns: 1fr;
            }
            
            .search-box {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔍 FactCheck AI</h1>
            <p>실시간 웹 검색과 AI를 활용한 가짜뉴스 검증 서비스</p>
        </div>

        <div class="search-container">
            <div class="search-box">
                <input type="text" id="newsQuery" placeholder="검증하고 싶은 뉴스나 정보를 입력하세요..." />
                <button id="verifyBtn">🔍 검증하기</button>
            </div>
            <div id="loading" class="loading" style="display: none;">
                <div>🔄 뉴스를 검증하고 있습니다...</div>
            </div>
            <div id="error" class="error" style="display: none;"></div>
        </div>

        <div id="results" class="results-container">
            <div class="result-card">
                <div class="card-title">📊 신뢰도 분석</div>
                <div class="credibility-score">
                    <div id="scoreCircle" class="score-circle">0</div>
                    <div id="scoreText">신뢰도 점수</div>
                </div>
                <div id="newsList" class="news-list"></div>
            </div>

            <div class="result-card">
                <div class="card-title">🗺️ 관련 뉴스 마인드맵</div>
                <svg id="mindmapSvg" class="mindmap-svg"></svg>
            </div>

            <div class="result-card">
                <div class="card-title">📈 시간대별 뉴스 발행 트렌드</div>
                <div id="timeline" class="timeline-container"></div>
            </div>

            <div class="result-card">
                <div class="card-title">📝 AI 분석 결과</div>
                <div id="analysis"></div>
            </div>
        </div>
    </div>

    <script>
        console.log('🚀 FactCheck AI 로드됨');

        // DOM 요소들
        const newsQuery = document.getElementById('newsQuery');
        const verifyBtn = document.getElementById('verifyBtn');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const results = document.getElementById('results');

        // 이벤트 리스너
        verifyBtn.addEventListener('click', verifyNews);
        newsQuery.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                verifyNews();
            }
        });

        // 뉴스 검증 함수
        async function verifyNews() {
            const query = newsQuery.value.trim();
            if (!query) {
                showError('검색어를 입력해주세요.');
                return;
            }

            console.log('🔍 검증 시작:', query);
            showLoading(true);
            hideError();

            try {
                const response = await fetch('/api/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: query })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('📦 받은 데이터:', data);

                displayResults(data);
                
            } catch (err) {
                console.error('❌ 오류:', err);
                showError('서버에 연결할 수 없습니다. 잠시 후 다시 시도해주세요.');
            } finally {
                showLoading(false);
            }
        }

        // 결과 표시 함수
        function displayResults(data) {
            console.log('📊 결과 표시 중:', data);
            
            // 신뢰도 점수 표시
            displayCredibilityScore(data.credibilityScore);
            
            // 뉴스 목록 표시
            displayNewsList(data.sources);
            
            // 마인드맵 생성
            createMindMap(data.query, data.sources);
            
            // 타임라인 표 생성
            createTimeline(data.sources);
            
            // AI 분석 결과 표시
            displayAnalysis(data.analysis);
            
            // 결과 컨테이너 표시
            results.style.display = 'grid';
        }

        // 신뢰도 점수 표시 (설명 추가)
        function displayCredibilityScore(score) {
            const scoreCircle = document.getElementById('scoreCircle');
            const scoreText = document.getElementById('scoreText');
            
            scoreCircle.textContent = score;
            
            // 점수에 따른 색상과 설명 변경
            let color, description, status;
            if (score >= 80) {
                color = 'conic-gradient(from 0deg, #00ff88, #00ff88)';
                status = '높은 신뢰도';
                description = '다수의 신뢰할 수 있는 출처에서 검색어와 높은 연관성을 가진 정보를 확인했습니다.';
            } else if (score >= 60) {
                color = 'conic-gradient(from 0deg, #ffaa00, #ffaa00)';
                status = '보통 신뢰도';
                description = '일부 신뢰할 수 있는 출처에서 관련 정보를 확인했으나 추가 검증이 권장됩니다.';
            } else if (score >= 40) {
                color = 'conic-gradient(from 0deg, #ff6b6b, #ff6b6b)';
                status = '낮은 신뢰도';
                description = '제한적인 출처에서만 정보를 확인했습니다. 신중한 판단이 필요합니다.';
            } else {
                color = 'conic-gradient(from 0deg, #ff4444, #ff4444)';
                status = '매우 낮은 신뢰도';
                description = '검색어와 연관성이 낮거나 신뢰할 수 있는 출처를 찾지 못했습니다.';
            }
            
            scoreCircle.style.background = color;
            scoreText.innerHTML = `
                <div style="font-size: 16px; font-weight: bold; margin-bottom: 8px;">${status}</div>
                <div style="font-size: 12px; line-height: 1.4; color: #ccc;">${description}</div>
                <div style="font-size: 10px; margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 5px;">
                    <strong>📊 점수 구성:</strong><br>
                    • 출처 신뢰도 (35%)<br>
                    • 검색어 연관성 (30%)<br>
                    • 날짜 신선도 (15%)<br>
                    • 제목 품질 (10%)<br>
                    • 기타 요소 (10%)
                </div>
            `;
        }

        // 뉴스 목록 표시 (개선된 버전)
        function displayNewsList(sources) {
            const newsList = document.getElementById('newsList');
            newsList.innerHTML = '';
            
            // 관련도순으로 정렬
            const sortedSources = sources.sort((a, b) => (b.relevanceScore || 0.5) - (a.relevanceScore || 0.5));
            
            // 필터 버튼 추가
            const filterContainer = document.createElement('div');
            filterContainer.style.marginBottom = '15px';
            filterContainer.innerHTML = `
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                    <button class="filter-btn active" data-filter="all">전체 (${sortedSources.length})</button>
                    <button class="filter-btn" data-filter="High">높은 신뢰도 (${sortedSources.filter(n => n.credibility === 'High').length})</button>
                    <button class="filter-btn" data-filter="Medium">보통 신뢰도 (${sortedSources.filter(n => n.credibility === 'Medium').length})</button>
                    <button class="filter-btn" data-filter="Low">낮은 신뢰도 (${sortedSources.filter(n => n.credibility === 'Low').length})</button>
                </div>
                <div style="font-size: 12px; color: #ccc; margin-bottom: 10px;">
                    📊 관련도순 정렬 | 💡 클릭하여 기사 보기
                </div>
            `;
            newsList.appendChild(filterContainer);
            
            // 뉴스 컨테이너
            const newsContainer = document.createElement('div');
            newsContainer.id = 'newsContainer';
            newsContainer.style.maxHeight = '400px';
            newsContainer.style.overflowY = 'auto';
            newsList.appendChild(newsContainer);
            
            // 뉴스 아이템들 생성
            function renderNews(newsToShow) {
                newsContainer.innerHTML = '';
                
                newsToShow.forEach((news, index) => {
                    const newsItem = document.createElement('div');
                    newsItem.className = 'news-item';
                    newsItem.onclick = () => window.open(news.url, '_blank');
                    
                    const credibilityColor = getCredibilityColor(news.credibility);
                    const relevanceScore = Math.round((news.relevanceScore || 0.5) * 100);
                    
                    newsItem.innerHTML = `
                        <div style="display: flex; justify-content: between; align-items: flex-start; gap: 10px;">
                            <div style="flex: 1;">
                                <div class="news-title" style="margin-bottom: 8px;">
                                    <span style="color: #888; font-size: 12px; margin-right: 8px;">#${index + 1}</span>
                                    ${news.title}
                                </div>
                                <div class="news-meta" style="display: flex; gap: 15px; flex-wrap: wrap;">
                                    <span style="color: ${credibilityColor}">🎯 ${news.credibility || 'Medium'}</span>
                                    <span style="color: #00ffff">📊 관련도 ${relevanceScore}%</span>
                                    ${news.publishedDate ? `<span style="color: #ffaa00">📅 ${news.publishedDate}</span>` : ''}
                                    ${news.domain ? `<span style="color: #ccc">🌐 ${news.domain}</span>` : ''}
                                </div>
                                ${news.description ? `<div style="font-size: 12px; color: #aaa; margin-top: 5px; line-height: 1.4;">${news.description}</div>` : ''}
                            </div>
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
                                <div style="width: 40px; height: 40px; border-radius: 50%; background: ${credibilityColor}; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">
                                    ${relevanceScore}
                                </div>
                                <div style="font-size: 10px; color: #888;">관련도</div>
                            </div>
                        </div>
                    `;
                    
                    newsContainer.appendChild(newsItem);
                });
            }
            
            // 초기 렌더링
            renderNews(sortedSources);
            
            // 필터 버튼 이벤트
            const filterBtns = filterContainer.querySelectorAll('.filter-btn');
            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // 활성 버튼 변경
                    filterBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // 필터링
                    const filter = btn.dataset.filter;
                    let filteredNews = sortedSources;
                    
                    if (filter !== 'all') {
                        filteredNews = sortedSources.filter(news => news.credibility === filter);
                    }
                    
                    renderNews(filteredNews);
                });
            });
        }

        // 방사형 마인드맵 생성 (키워드 노드 포함 + 확대/축소 기능)
        function createMindMap(centerKeyword, newsData) {
            const svg = d3.select('#mindmapSvg');
            svg.selectAll('*').remove();

            // SVG 크기 확인 및 설정
            const svgElement = svg.node();
            const rect = svgElement.getBoundingClientRect();
            const width = rect.width || 800;
            const height = rect.height || 500;
            
            svg.attr('width', width).attr('height', height);
            
            const centerX = width / 2;
            const centerY = height / 2;

            console.log(`📐 SVG 크기: ${width}x${height}, 중심: (${centerX}, ${centerY})`);

            // 확대/축소를 위한 그룹 생성
            const g = svg.append('g');

            // 확대/축소 기능 설정
            const zoom = d3.zoom()
                .scaleExtent([0.3, 3]) // 0.3배~3배 확대/축소
                .on('zoom', function(event) {
                    g.attr('transform', event.transform);
                });

            svg.call(zoom);

            // 확대/축소 컨트롤 버튼 추가
            const controls = svg.append('g')
                .attr('class', 'zoom-controls')
                .attr('transform', `translate(${width - 80}, 20)`);

            // 확대 버튼
            const zoomInBtn = controls.append('g')
                .style('cursor', 'pointer')
                .on('click', function() {
                    svg.transition().duration(300).call(
                        zoom.scaleBy, 1.5
                    );
                });

            zoomInBtn.append('circle')
                .attr('r', 20)
                .attr('fill', 'rgba(255, 0, 110, 0.8)')
                .attr('stroke', 'white')
                .attr('stroke-width', 2);

            zoomInBtn.append('text')
                .attr('text-anchor', 'middle')
                .attr('dy', '0.35em')
                .attr('fill', 'white')
                .attr('font-size', '16px')
                .attr('font-weight', 'bold')
                .text('+');

            // 축소 버튼
            const zoomOutBtn = controls.append('g')
                .attr('transform', 'translate(0, 50)')
                .style('cursor', 'pointer')
                .on('click', function() {
                    svg.transition().duration(300).call(
                        zoom.scaleBy, 0.67
                    );
                });

            zoomOutBtn.append('circle')
                .attr('r', 20)
                .attr('fill', 'rgba(0, 255, 255, 0.8)')
                .attr('stroke', 'white')
                .attr('stroke-width', 2);

            zoomOutBtn.append('text')
                .attr('text-anchor', 'middle')
                .attr('dy', '0.35em')
                .attr('fill', 'white')
                .attr('font-size', '16px')
                .attr('font-weight', 'bold')
                .text('−');

            // 리셋 버튼
            const resetBtn = controls.append('g')
                .attr('transform', 'translate(0, 100)')
                .style('cursor', 'pointer')
                .on('click', function() {
                    svg.transition().duration(500).call(
                        zoom.transform,
                        d3.zoomIdentity
                    );
                });

            resetBtn.append('circle')
                .attr('r', 20)
                .attr('fill', 'rgba(168, 85, 247, 0.8)')
                .attr('stroke', 'white')
                .attr('stroke-width', 2);

            resetBtn.append('text')
                .attr('text-anchor', 'middle')
                .attr('dy', '0.35em')
                .attr('fill', 'white')
                .attr('font-size', '12px')
                .attr('font-weight', 'bold')
                .text('⌂');

            // 키워드 추출 함수
            function extractKeywords(newsData) {
                const keywords = new Set();
                newsData.forEach(news => {
                    // 제목에서 키워드 추출 (간단한 방식)
                    const words = news.title.split(/[\s,.-]+/).filter(word => 
                        word.length > 1 && 
                        !['관련', '대한', '위한', '통해', '따른', '의해', '에서', '에게', '으로', '에는', '에도', '뉴스', '기사'].includes(word)
                    );
                    words.slice(0, 2).forEach(word => keywords.add(word)); // 상위 2개 단어만
                });
                return Array.from(keywords).slice(0, 8); // 최대 8개 키워드
            }

            const keywords = extractKeywords(newsData);

            // 중심 노드 (이제 드래그 가능)
            const centerNode = {
                x: centerX,
                y: centerY,
                text: centerKeyword,
                type: 'center',
                radius: 45,
                id: 'center'
            };

            // 키워드 노드들을 중간 거리에 배치
            const keywordNodes = keywords.map((keyword, i) => {
                const angle = (i / keywords.length) * 2 * Math.PI;
                const radius = 100;
                
                return {
                    x: centerX + Math.cos(angle) * radius,
                    y: centerY + Math.sin(angle) * radius,
                    text: keyword,
                    type: 'keyword',
                    radius: 25,
                    id: `keyword-${i}`,
                    color: ['#ff9500', '#00d4ff', '#a855f7', '#00ff88', '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4'][i % 8]
                };
            });

            // 뉴스 노드들을 외곽에 배치하고 관련 키워드와 연결
            const newsNodes = newsData.map((news, i) => {
                const angle = (i / newsData.length) * 2 * Math.PI;
                const radius = 180 + Math.random() * 60;
                
                // 뉴스 제목에서 관련 키워드 찾기
                const relatedKeywords = keywords.filter(keyword => 
                    news.title.toLowerCase().includes(keyword.toLowerCase())
                );
                
                return {
                    x: centerX + Math.cos(angle) * radius,
                    y: centerY + Math.sin(angle) * radius,
                    text: news.title.length > 20 ? news.title.substring(0, 20) + '...' : news.title,
                    fullTitle: news.title,
                    url: news.url,
                    type: 'news',
                    credibility: news.credibility || 'Medium',
                    credibilityColor: getCredibilityColor(news.credibility || 'Medium'),
                    radius: 18,
                    id: `news-${i}`,
                    relatedKeywords: relatedKeywords,
                    publishedDate: news.publishedDate
                };
            });

            const allNodes = [centerNode, ...keywordNodes, ...newsNodes];

            // 링크 데이터 생성
            const links = [];
            
            // 중심에서 키워드로의 링크
            keywordNodes.forEach(keyword => {
                links.push({
                    source: centerNode,
                    target: keyword,
                    type: 'center-keyword'
                });
            });

            // 키워드에서 관련 뉴스로의 링크
            newsNodes.forEach(news => {
                if (news.relatedKeywords.length > 0) {
                    // 가장 관련성 높은 키워드 하나와 연결
                    const relatedKeyword = keywordNodes.find(k => 
                        news.relatedKeywords.includes(k.text)
                    );
                    if (relatedKeyword) {
                        links.push({
                            source: relatedKeyword,
                            target: news,
                            type: 'keyword-news'
                        });
                    }
                } else {
                    // 관련 키워드가 없으면 중심과 직접 연결
                    links.push({
                        source: centerNode,
                        target: news,
                        type: 'center-news'
                    });
                }
            });

            // D3 시뮬레이션 설정 (개선된 상호작용)
            const simulation = d3.forceSimulation(allNodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(d => {
                    if (d.type === 'center-keyword') return 90;
                    if (d.type === 'keyword-news') return 70;
                    return 110;
                }).strength(0.8)) // 링크 강도 증가
                .force('charge', d3.forceManyBody().strength(d => {
                    if (d.type === 'center') return -400;
                    if (d.type === 'keyword') return -250;
                    return -150;
                }))
                .force('center', d3.forceCenter(centerX, centerY).strength(0.1))
                .force('collision', d3.forceCollide().radius(d => d.radius + 10).strength(0.7))
                .alpha(0.5)
                .alphaDecay(0.02); // 더 천천히 안정화

            // 링크 그리기 (g 그룹에 추가)
            const linkElements = g.append('g')
                .selectAll('line')
                .data(links)
                .enter()
                .append('line')
                .attr('stroke', d => {
                    if (d.type === 'center-keyword') return '#ff006e';
                    if (d.type === 'keyword-news') return '#00ffff';
                    return '#888';
                })
                .attr('stroke-width', d => {
                    if (d.type === 'center-keyword') return 3;
                    return 2;
                })
                .attr('opacity', 0.6);

            // 노드 그룹 생성 (g 그룹에 추가)
            const nodeElements = g.append('g')
                .selectAll('g')
                .data(allNodes)
                .enter()
                .append('g')
                .attr('class', 'node')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            // 원형 노드
            nodeElements.append('circle')
                .attr('r', d => d.radius)
                .attr('fill', d => {
                    if (d.type === 'center') return '#ff006e';
                    if (d.type === 'keyword') return d.color;
                    return d.credibilityColor;
                })
                .attr('stroke', '#fff')
                .attr('stroke-width', d => d.type === 'center' ? 4 : 2)
                .style('filter', d => {
                    if (d.type === 'center') return 'drop-shadow(0 0 20px rgba(255, 0, 110, 0.8))';
                    if (d.type === 'keyword') return `drop-shadow(0 0 15px ${d.color}60)`;
                    return `drop-shadow(0 0 10px ${d.credibilityColor}60)`;
                })
                .style('cursor', 'grab')
                .on('click', function(event, d) {
                    if (d.type === 'news' && d.url) {
                        window.open(d.url, '_blank');
                    }
                })
                .on('mouseover', function(event, d) {
                    showTooltip(event, d);
                    d3.select(this).style('cursor', 'grab');
                })
                .on('mouseout', function() {
                    hideTooltip();
                });

            // 텍스트 레이블
            nodeElements.append('text')
                .attr('text-anchor', 'middle')
                .attr('dy', '0.35em')
                .attr('fill', 'white')
                .attr('font-size', d => {
                    if (d.type === 'center') return '14px';
                    if (d.type === 'keyword') return '11px';
                    return '9px';
                })
                .attr('font-weight', d => d.type === 'center' ? 'bold' : 'normal')
                .text(d => d.text)
                .style('pointer-events', 'none')
                .style('user-select', 'none');

            // 시뮬레이션 틱 이벤트
            simulation.on('tick', () => {
                // 노드들이 SVG 경계를 벗어나지 않도록 제한
                allNodes.forEach(d => {
                    d.x = Math.max(d.radius, Math.min(width - d.radius, d.x));
                    d.y = Math.max(d.radius, Math.min(height - d.radius, d.y));
                });

                // 링크 위치 업데이트
                linkElements
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                // 노드 위치 업데이트
                nodeElements
                    .attr('transform', d => `translate(${d.x}, ${d.y})`);
            });

            // 개선된 드래그 함수들
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.5).restart();
                
                // 드래그되는 노드 고정
                d.fx = d.x;
                d.fy = d.y;
                
                // 연결된 노드들도 함께 움직이도록 설정
                if (d.type === 'center') {
                    // 중심 노드를 드래그하면 키워드 노드들도 함께
                    keywordNodes.forEach(keyword => {
                        keyword.fx = keyword.x;
                        keyword.fy = keyword.y;
                    });
                } else if (d.type === 'keyword') {
                    // 키워드 노드를 드래그하면 연결된 뉴스 노드들도 함께
                    const connectedNews = newsNodes.filter(news => 
                        news.relatedKeywords.includes(d.text)
                    );
                    connectedNews.forEach(news => {
                        news.fx = news.x;
                        news.fy = news.y;
                    });
                }
                
                d3.select(this).style('cursor', 'grabbing');
            }

            function dragged(event, d) {
                const dx = event.x - d.x;
                const dy = event.y - d.y;
                
                // 드래그되는 노드 이동
                d.fx = event.x;
                d.fy = event.y;
                
                // 연결된 노드들도 함께 이동
                if (d.type === 'center') {
                    keywordNodes.forEach(keyword => {
                        if (keyword.fx !== null) {
                            keyword.fx += dx * 0.3; // 30% 정도만 따라움직임
                            keyword.fy += dy * 0.3;
                        }
                    });
                } else if (d.type === 'keyword') {
                    const connectedNews = newsNodes.filter(news => 
                        news.relatedKeywords.includes(d.text)
                    );
                    connectedNews.forEach(news => {
                        if (news.fx !== null) {
                            news.fx += dx * 0.5; // 50% 정도 따라움직임
                            news.fy += dy * 0.5;
                        }
                    });
                }
            }

            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                
                // 모든 노드의 고정 해제 (자연스러운 움직임을 위해)
                setTimeout(() => {
                    allNodes.forEach(node => {
                        node.fx = null;
                        node.fy = null;
                    });
                }, 500); // 0.5초 후 해제
                
                d3.select(this).style('cursor', 'grab');
            }

            // 툴팁 함수들
            function showTooltip(event, d) {
                let tooltipContent = '';
                
                if (d.type === 'center') {
                    tooltipContent = `<strong>🎯 검색 키워드</strong><br>${d.text}`;
                } else if (d.type === 'keyword') {
                    tooltipContent = `<strong>🔑 관련 키워드</strong><br>${d.text}`;
                } else if (d.type === 'news') {
                    tooltipContent = `
                        <strong>${d.fullTitle}</strong><br>
                        <span style="color: ${d.credibilityColor}">신뢰도: ${d.credibility}</span><br>
                        ${d.publishedDate ? `📅 ${d.publishedDate}` : '📅 날짜 미상'}<br>
                        <small>클릭하여 기사 보기</small>
                    `;
                }

                const tooltip = d3.select('body').append('div')
                    .attr('class', 'mindmap-tooltip')
                    .style('position', 'absolute')
                    .style('background', 'rgba(0, 0, 0, 0.9)')
                    .style('color', 'white')
                    .style('padding', '10px')
                    .style('border-radius', '5px')
                    .style('pointer-events', 'none')
                    .style('font-size', '12px')
                    .style('max-width', '200px')
                    .style('z-index', '1000')
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 10) + 'px')
                    .html(tooltipContent);
            }

            function hideTooltip() {
                d3.selectAll('.mindmap-tooltip').remove();
            }

            // 사용법 안내 추가
            const instructions = svg.append('g')
                .attr('class', 'instructions')
                .attr('transform', 'translate(10, 20)');

            instructions.append('text')
                .attr('fill', 'rgba(255, 255, 255, 0.7)')
                .attr('font-size', '12px')
                .text('💡 마우스 휠로 확대/축소, 드래그로 이동, 우측 버튼으로 조작');
        }

        // 시간대별 뉴스 표 생성 (날짜 표시 개선)
        function createTimeline(newsData) {
            const container = d3.select('#timeline');
            container.selectAll('*').remove();

            // 뉴스를 날짜별로 그룹화 (publishedDate 사용)
            const newsByDate = {};
            newsData.forEach(news => {
                let date = '날짜 미상';
                if (news.publishedDate) {
                    // 날짜 형식 정규화
                    try {
                        const dateObj = new Date(news.publishedDate);
                        if (!isNaN(dateObj.getTime())) {
                            date = dateObj.toLocaleDateString('ko-KR');
                        }
                    } catch (e) {
                        console.log('날짜 파싱 오류:', news.publishedDate);
                    }
                } else if (news.publishedAt) {
                    // publishedAt도 확인
                    try {
                        const dateObj = new Date(news.publishedAt);
                        if (!isNaN(dateObj.getTime())) {
                            date = dateObj.toLocaleDateString('ko-KR');
                        }
                    } catch (e) {
                        console.log('날짜 파싱 오류:', news.publishedAt);
                    }
                }
                
                if (!newsByDate[date]) {
                    newsByDate[date] = [];
                }
                newsByDate[date].push(news);
            });

            console.log('📅 날짜별 뉴스 그룹:', newsByDate);

            // 날짜순으로 정렬 (오름차순 - 오래된 기사부터)
            const sortedDates = Object.keys(newsByDate).sort((a, b) => {
                if (a === '날짜 미상') return 1;
                if (b === '날짜 미상') return -1;
                
                try {
                    const dateA = new Date(a.split('.').reverse().join('-'));
                    const dateB = new Date(b.split('.').reverse().join('-'));
                    return dateA - dateB; // 오름차순 (오래된 순)
                } catch (e) {
                    return 0;
                }
            });

            // 표 생성
            const table = container.append('table');

            // 헤더
            const header = table.append('thead').append('tr');
            header.append('th').text('📅 발행일').style('width', '120px');
            header.append('th').text('📰 뉴스 제목');
            header.append('th').text('🎯 신뢰도').style('width', '100px').style('text-align', 'center');

            // 바디
            const tbody = table.append('tbody');

            sortedDates.forEach(date => {
                const newsForDate = newsByDate[date];
                
                newsForDate.forEach((news, newsIndex) => {
                    const row = tbody.append('tr')
                        .style('cursor', news.url ? 'pointer' : 'default')
                        .on('click', function() {
                            if (news.url) {
                                window.open(news.url, '_blank');
                            }
                        });

                    // 날짜 셀 (첫 번째 뉴스에만 표시)
                    if (newsIndex === 0) {
                        row.append('td')
                            .text(date)
                            .style('color', date === '날짜 미상' ? '#ffaa00' : '#00ffff')
                            .style('font-weight', 'bold')
                            .style('vertical-align', 'top')
                            .style('border-right', '2px solid rgba(255, 255, 255, 0.2)')
                            .attr('rowspan', newsForDate.length);
                    }

                    // 제목 셀
                    row.append('td')
                        .text(news.title)
                        .style('padding-left', '15px');

                    // 신뢰도 셀
                    row.append('td')
                        .text(news.credibility || 'Medium')
                        .style('color', getCredibilityColor(news.credibility || 'Medium'))
                        .style('font-weight', 'bold')
                        .style('text-align', 'center');
                });
            });

            // 통계 정보 추가
            const statsDiv = container.append('div')
                .style('margin-top', '15px')
                .style('padding', '10px')
                .style('background', 'rgba(255, 255, 255, 0.1)')
                .style('border-radius', '8px')
                .style('font-size', '14px');

            const totalNews = newsData.length;
            const datesWithNews = sortedDates.filter(date => date !== '날짜 미상').length;
            const unknownDateNews = newsByDate['날짜 미상'] ? newsByDate['날짜 미상'].length : 0;

            statsDiv.html(`
                <strong>📊 통계 정보</strong><br>
                • 총 뉴스 개수: ${totalNews}개<br>
                • 날짜 확인된 뉴스: ${totalNews - unknownDateNews}개<br>
                • 발행일 범위: ${datesWithNews}일간<br>
                ${unknownDateNews > 0 ? `• 날짜 미상: ${unknownDateNews}개` : ''}
            `);
        }

        // AI 분석 결과 표시
        function displayAnalysis(analysis) {
            const analysisDiv = document.getElementById('analysis');
            analysisDiv.innerHTML = `
                <div style="line-height: 1.6;">
                    <p><strong>📊 종합 분석:</strong></p>
                    <p>${analysis.summary || '분석 결과를 준비 중입니다.'}</p>
                    
                    <p style="margin-top: 15px;"><strong>🔍 주요 발견사항:</strong></p>
                    <ul style="margin-left: 20px;">
                        ${analysis.keyFindings ? analysis.keyFindings.map(finding => `<li>${finding}</li>`).join('') : '<li>분석 중입니다.</li>'}
                    </ul>
                    
                    <p style="margin-top: 15px;"><strong>💡 권장사항:</strong></p>
                    <p>${analysis.recommendation || '추가 검증을 권장합니다.'}</p>
                </div>
            `;
        }

        // 신뢰도에 따른 색상 반환
        function getCredibilityColor(credibility) {
            const colors = {
                'High': '#00ff88',
                'Medium': '#ffaa00',
                'Low': '#ff4444'
            };
            return colors[credibility] || colors['Medium'];
        }

        // 로딩 표시/숨김
        function showLoading(show) {
            loading.style.display = show ? 'block' : 'none';
            if (show) {
                results.style.display = 'none';
            }
        }

        // 에러 표시
        function showError(message) {
            error.textContent = message;
            error.style.display = 'block';
        }

        // 에러 숨김
        function hideError() {
            error.style.display = 'none';
        }

        console.log('✅ JavaScript 로드 완료');
    </script>
</body>
</html>
