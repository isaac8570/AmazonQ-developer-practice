<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FactCheck AI - ë‰´ìŠ¤ ê²€ì¦ í”Œë«í¼</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff006e, #00ffff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .search-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .search-box {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        #newsQuery {
            flex: 1;
            padding: 15px 20px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 16px;
        }

        #verifyBtn {
            padding: 15px 30px;
            background: linear-gradient(45deg, #ff006e, #8338ec);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        #verifyBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 0, 110, 0.3);
        }

        .results-container {
            display: none;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }

        .result-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .card-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
            color: #00ffff;
        }

        .credibility-score {
            text-align: center;
            margin-bottom: 30px;
        }

        .score-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            background: conic-gradient(from 0deg, #ff4444, #ffaa00, #00ff88);
        }

        .mindmap-svg {
            width: 100%;
            height: 500px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .timeline-container {
            width: 100%;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .timeline-container::-webkit-scrollbar {
            width: 8px;
        }

        .timeline-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .timeline-container::-webkit-scrollbar-thumb {
            background: #ff006e;
            border-radius: 4px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            overflow: hidden;
        }

        th {
            padding: 15px;
            background: #ff006e;
            color: white;
            font-weight: bold;
            text-align: left;
        }

        td {
            padding: 12px 15px;
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .news-list {
            margin-top: 20px;
        }

        .news-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .news-item:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }

        .news-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .news-meta {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2rem;
        }

        .error {
            background: rgba(255, 68, 68, 0.2);
            border: 1px solid #ff4444;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .filter-btn {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 20px;
            color: white;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .filter-btn.active {
            background: #ff006e;
            border-color: #ff006e;
            box-shadow: 0 0 10px rgba(255, 0, 110, 0.5);
        }

        .zoom-controls {
            pointer-events: all;
        }

        .zoom-controls g:hover circle {
            opacity: 0.9;
            transform: scale(1.1);
            transition: all 0.2s ease;
        }

        .instructions {
            pointer-events: none;
        }

        #newsContainer::-webkit-scrollbar {
            width: 6px;
        }

        #newsContainer::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        #newsContainer::-webkit-scrollbar-thumb {
            background: #ff006e;
            border-radius: 3px;
        }

        @media (max-width: 768px) {
            .results-container {
                grid-template-columns: 1fr;
            }
            
            .search-box {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” FactCheck AI</h1>
            <p>ì‹¤ì‹œê°„ ì›¹ ê²€ìƒ‰ê³¼ AIë¥¼ í™œìš©í•œ ê°€ì§œë‰´ìŠ¤ ê²€ì¦ ì„œë¹„ìŠ¤</p>
        </div>

        <div class="search-container">
            <div class="search-box">
                <input type="text" id="newsQuery" placeholder="ê²€ì¦í•˜ê³  ì‹¶ì€ ë‰´ìŠ¤ë‚˜ ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." />
                <button id="verifyBtn">ğŸ” ê²€ì¦í•˜ê¸°</button>
            </div>
            <div id="loading" class="loading" style="display: none;">
                <div>ğŸ”„ ë‰´ìŠ¤ë¥¼ ê²€ì¦í•˜ê³  ìˆìŠµë‹ˆë‹¤...</div>
            </div>
            <div id="error" class="error" style="display: none;"></div>
        </div>

        <div id="results" class="results-container">
            <div class="result-card">
                <div class="card-title">ğŸ“Š ì‹ ë¢°ë„ ë¶„ì„</div>
                <div class="credibility-score">
                    <div id="scoreCircle" class="score-circle">0</div>
                    <div id="scoreText">ì‹ ë¢°ë„ ì ìˆ˜</div>
                </div>
                <div id="newsList" class="news-list"></div>
            </div>

            <div class="result-card">
                <div class="card-title">ğŸ—ºï¸ ê´€ë ¨ ë‰´ìŠ¤ ë§ˆì¸ë“œë§µ</div>
                <svg id="mindmapSvg" class="mindmap-svg"></svg>
            </div>

            <div class="result-card">
                <div class="card-title">ğŸ“ˆ ì‹œê°„ëŒ€ë³„ ë‰´ìŠ¤ ë°œí–‰ íŠ¸ë Œë“œ</div>
                <div id="timeline" class="timeline-container"></div>
            </div>

            <div class="result-card">
                <div class="card-title">ğŸ“ AI ë¶„ì„ ê²°ê³¼</div>
                <div id="analysis"></div>
            </div>
        </div>
    </div>

    <script>
        console.log('ğŸš€ FactCheck AI ë¡œë“œë¨');

        // DOM ìš”ì†Œë“¤
        const newsQuery = document.getElementById('newsQuery');
        const verifyBtn = document.getElementById('verifyBtn');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const results = document.getElementById('results');

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        verifyBtn.addEventListener('click', verifyNews);
        newsQuery.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                verifyNews();
            }
        });

        // ë‰´ìŠ¤ ê²€ì¦ í•¨ìˆ˜
        async function verifyNews() {
            const query = newsQuery.value.trim();
            if (!query) {
                showError('ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            console.log('ğŸ” ê²€ì¦ ì‹œì‘:', query);
            showLoading(true);
            hideError();

            try {
                const response = await fetch('/api/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: query })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('ğŸ“¦ ë°›ì€ ë°ì´í„°:', data);

                displayResults(data);
                
            } catch (err) {
                console.error('âŒ ì˜¤ë¥˜:', err);
                showError('ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            } finally {
                showLoading(false);
            }
        }

        // ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
        function displayResults(data) {
            console.log('ğŸ“Š ê²°ê³¼ í‘œì‹œ ì¤‘:', data);
            
            // ì‹ ë¢°ë„ ì ìˆ˜ í‘œì‹œ
            displayCredibilityScore(data.credibilityScore);
            
            // ë‰´ìŠ¤ ëª©ë¡ í‘œì‹œ
            displayNewsList(data.sources);
            
            // ë§ˆì¸ë“œë§µ ìƒì„±
            createMindMap(data.query, data.sources);
            
            // íƒ€ì„ë¼ì¸ í‘œ ìƒì„±
            createTimeline(data.sources);
            
            // AI ë¶„ì„ ê²°ê³¼ í‘œì‹œ
            displayAnalysis(data.analysis);
            
            // ê²°ê³¼ ì»¨í…Œì´ë„ˆ í‘œì‹œ
            results.style.display = 'grid';
        }

        // ì‹ ë¢°ë„ ì ìˆ˜ í‘œì‹œ (ì„¤ëª… ì¶”ê°€)
        function displayCredibilityScore(score) {
            const scoreCircle = document.getElementById('scoreCircle');
            const scoreText = document.getElementById('scoreText');
            
            scoreCircle.textContent = score;
            
            // ì ìˆ˜ì— ë”°ë¥¸ ìƒ‰ìƒê³¼ ì„¤ëª… ë³€ê²½
            let color, description, status;
            if (score >= 80) {
                color = 'conic-gradient(from 0deg, #00ff88, #00ff88)';
                status = 'ë†’ì€ ì‹ ë¢°ë„';
                description = 'ë‹¤ìˆ˜ì˜ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ì¶œì²˜ì—ì„œ ê²€ìƒ‰ì–´ì™€ ë†’ì€ ì—°ê´€ì„±ì„ ê°€ì§„ ì •ë³´ë¥¼ í™•ì¸í–ˆìŠµë‹ˆë‹¤.';
            } else if (score >= 60) {
                color = 'conic-gradient(from 0deg, #ffaa00, #ffaa00)';
                status = 'ë³´í†µ ì‹ ë¢°ë„';
                description = 'ì¼ë¶€ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ì¶œì²˜ì—ì„œ ê´€ë ¨ ì •ë³´ë¥¼ í™•ì¸í–ˆìœ¼ë‚˜ ì¶”ê°€ ê²€ì¦ì´ ê¶Œì¥ë©ë‹ˆë‹¤.';
            } else if (score >= 40) {
                color = 'conic-gradient(from 0deg, #ff6b6b, #ff6b6b)';
                status = 'ë‚®ì€ ì‹ ë¢°ë„';
                description = 'ì œí•œì ì¸ ì¶œì²˜ì—ì„œë§Œ ì •ë³´ë¥¼ í™•ì¸í–ˆìŠµë‹ˆë‹¤. ì‹ ì¤‘í•œ íŒë‹¨ì´ í•„ìš”í•©ë‹ˆë‹¤.';
            } else {
                color = 'conic-gradient(from 0deg, #ff4444, #ff4444)';
                status = 'ë§¤ìš° ë‚®ì€ ì‹ ë¢°ë„';
                description = 'ê²€ìƒ‰ì–´ì™€ ì—°ê´€ì„±ì´ ë‚®ê±°ë‚˜ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ì¶œì²˜ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
            }
            
            scoreCircle.style.background = color;
            scoreText.innerHTML = `
                <div style="font-size: 16px; font-weight: bold; margin-bottom: 8px;">${status}</div>
                <div style="font-size: 12px; line-height: 1.4; color: #ccc;">${description}</div>
                <div style="font-size: 10px; margin-top: 8px; padding: 8px; background: rgba(255,255,255,0.1); border-radius: 5px;">
                    <strong>ğŸ“Š ì ìˆ˜ êµ¬ì„±:</strong><br>
                    â€¢ ì¶œì²˜ ì‹ ë¢°ë„ (35%)<br>
                    â€¢ ê²€ìƒ‰ì–´ ì—°ê´€ì„± (30%)<br>
                    â€¢ ë‚ ì§œ ì‹ ì„ ë„ (15%)<br>
                    â€¢ ì œëª© í’ˆì§ˆ (10%)<br>
                    â€¢ ê¸°íƒ€ ìš”ì†Œ (10%)
                </div>
            `;
        }

        // ë‰´ìŠ¤ ëª©ë¡ í‘œì‹œ (ê°œì„ ëœ ë²„ì „)
        function displayNewsList(sources) {
            const newsList = document.getElementById('newsList');
            newsList.innerHTML = '';
            
            // ê´€ë ¨ë„ìˆœìœ¼ë¡œ ì •ë ¬
            const sortedSources = sources.sort((a, b) => (b.relevanceScore || 0.5) - (a.relevanceScore || 0.5));
            
            // í•„í„° ë²„íŠ¼ ì¶”ê°€
            const filterContainer = document.createElement('div');
            filterContainer.style.marginBottom = '15px';
            filterContainer.innerHTML = `
                <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 10px;">
                    <button class="filter-btn active" data-filter="all">ì „ì²´ (${sortedSources.length})</button>
                    <button class="filter-btn" data-filter="High">ë†’ì€ ì‹ ë¢°ë„ (${sortedSources.filter(n => n.credibility === 'High').length})</button>
                    <button class="filter-btn" data-filter="Medium">ë³´í†µ ì‹ ë¢°ë„ (${sortedSources.filter(n => n.credibility === 'Medium').length})</button>
                    <button class="filter-btn" data-filter="Low">ë‚®ì€ ì‹ ë¢°ë„ (${sortedSources.filter(n => n.credibility === 'Low').length})</button>
                </div>
                <div style="font-size: 12px; color: #ccc; margin-bottom: 10px;">
                    ğŸ“Š ê´€ë ¨ë„ìˆœ ì •ë ¬ | ğŸ’¡ í´ë¦­í•˜ì—¬ ê¸°ì‚¬ ë³´ê¸°
                </div>
            `;
            newsList.appendChild(filterContainer);
            
            // ë‰´ìŠ¤ ì»¨í…Œì´ë„ˆ
            const newsContainer = document.createElement('div');
            newsContainer.id = 'newsContainer';
            newsContainer.style.maxHeight = '400px';
            newsContainer.style.overflowY = 'auto';
            newsList.appendChild(newsContainer);
            
            // ë‰´ìŠ¤ ì•„ì´í…œë“¤ ìƒì„±
            function renderNews(newsToShow) {
                newsContainer.innerHTML = '';
                
                newsToShow.forEach((news, index) => {
                    const newsItem = document.createElement('div');
                    newsItem.className = 'news-item';
                    newsItem.onclick = () => window.open(news.url, '_blank');
                    
                    const credibilityColor = getCredibilityColor(news.credibility);
                    const relevanceScore = Math.round((news.relevanceScore || 0.5) * 100);
                    
                    newsItem.innerHTML = `
                        <div style="display: flex; justify-content: between; align-items: flex-start; gap: 10px;">
                            <div style="flex: 1;">
                                <div class="news-title" style="margin-bottom: 8px;">
                                    <span style="color: #888; font-size: 12px; margin-right: 8px;">#${index + 1}</span>
                                    ${news.title}
                                </div>
                                <div class="news-meta" style="display: flex; gap: 15px; flex-wrap: wrap;">
                                    <span style="color: ${credibilityColor}">ğŸ¯ ${news.credibility || 'Medium'}</span>
                                    <span style="color: #00ffff">ğŸ“Š ê´€ë ¨ë„ ${relevanceScore}%</span>
                                    ${news.publishedDate ? `<span style="color: #ffaa00">ğŸ“… ${news.publishedDate}</span>` : ''}
                                    ${news.domain ? `<span style="color: #ccc">ğŸŒ ${news.domain}</span>` : ''}
                                </div>
                                ${news.description ? `<div style="font-size: 12px; color: #aaa; margin-top: 5px; line-height: 1.4;">${news.description}</div>` : ''}
                            </div>
                            <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
                                <div style="width: 40px; height: 40px; border-radius: 50%; background: ${credibilityColor}; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">
                                    ${relevanceScore}
                                </div>
                                <div style="font-size: 10px; color: #888;">ê´€ë ¨ë„</div>
                            </div>
                        </div>
                    `;
                    
                    newsContainer.appendChild(newsItem);
                });
            }
            
            // ì´ˆê¸° ë Œë”ë§
            renderNews(sortedSources);
            
            // í•„í„° ë²„íŠ¼ ì´ë²¤íŠ¸
            const filterBtns = filterContainer.querySelectorAll('.filter-btn');
            filterBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // í™œì„± ë²„íŠ¼ ë³€ê²½
                    filterBtns.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    // í•„í„°ë§
                    const filter = btn.dataset.filter;
                    let filteredNews = sortedSources;
                    
                    if (filter !== 'all') {
                        filteredNews = sortedSources.filter(news => news.credibility === filter);
                    }
                    
                    renderNews(filteredNews);
                });
            });
        }

        // ë°©ì‚¬í˜• ë§ˆì¸ë“œë§µ ìƒì„± (í‚¤ì›Œë“œ ë…¸ë“œ í¬í•¨ + í™•ëŒ€/ì¶•ì†Œ ê¸°ëŠ¥)
        function createMindMap(centerKeyword, newsData) {
            const svg = d3.select('#mindmapSvg');
            svg.selectAll('*').remove();

            // SVG í¬ê¸° í™•ì¸ ë° ì„¤ì •
            const svgElement = svg.node();
            const rect = svgElement.getBoundingClientRect();
            const width = rect.width || 800;
            const height = rect.height || 500;
            
            svg.attr('width', width).attr('height', height);
            
            const centerX = width / 2;
            const centerY = height / 2;

            console.log(`ğŸ“ SVG í¬ê¸°: ${width}x${height}, ì¤‘ì‹¬: (${centerX}, ${centerY})`);

            // í™•ëŒ€/ì¶•ì†Œë¥¼ ìœ„í•œ ê·¸ë£¹ ìƒì„±
            const g = svg.append('g');

            // í™•ëŒ€/ì¶•ì†Œ ê¸°ëŠ¥ ì„¤ì •
            const zoom = d3.zoom()
                .scaleExtent([0.3, 3]) // 0.3ë°°~3ë°° í™•ëŒ€/ì¶•ì†Œ
                .on('zoom', function(event) {
                    g.attr('transform', event.transform);
                });

            svg.call(zoom);

            // í™•ëŒ€/ì¶•ì†Œ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ì¶”ê°€
            const controls = svg.append('g')
                .attr('class', 'zoom-controls')
                .attr('transform', `translate(${width - 80}, 20)`);

            // í™•ëŒ€ ë²„íŠ¼
            const zoomInBtn = controls.append('g')
                .style('cursor', 'pointer')
                .on('click', function() {
                    svg.transition().duration(300).call(
                        zoom.scaleBy, 1.5
                    );
                });

            zoomInBtn.append('circle')
                .attr('r', 20)
                .attr('fill', 'rgba(255, 0, 110, 0.8)')
                .attr('stroke', 'white')
                .attr('stroke-width', 2);

            zoomInBtn.append('text')
                .attr('text-anchor', 'middle')
                .attr('dy', '0.35em')
                .attr('fill', 'white')
                .attr('font-size', '16px')
                .attr('font-weight', 'bold')
                .text('+');

            // ì¶•ì†Œ ë²„íŠ¼
            const zoomOutBtn = controls.append('g')
                .attr('transform', 'translate(0, 50)')
                .style('cursor', 'pointer')
                .on('click', function() {
                    svg.transition().duration(300).call(
                        zoom.scaleBy, 0.67
                    );
                });

            zoomOutBtn.append('circle')
                .attr('r', 20)
                .attr('fill', 'rgba(0, 255, 255, 0.8)')
                .attr('stroke', 'white')
                .attr('stroke-width', 2);

            zoomOutBtn.append('text')
                .attr('text-anchor', 'middle')
                .attr('dy', '0.35em')
                .attr('fill', 'white')
                .attr('font-size', '16px')
                .attr('font-weight', 'bold')
                .text('âˆ’');

            // ë¦¬ì…‹ ë²„íŠ¼
            const resetBtn = controls.append('g')
                .attr('transform', 'translate(0, 100)')
                .style('cursor', 'pointer')
                .on('click', function() {
                    svg.transition().duration(500).call(
                        zoom.transform,
                        d3.zoomIdentity
                    );
                });

            resetBtn.append('circle')
                .attr('r', 20)
                .attr('fill', 'rgba(168, 85, 247, 0.8)')
                .attr('stroke', 'white')
                .attr('stroke-width', 2);

            resetBtn.append('text')
                .attr('text-anchor', 'middle')
                .attr('dy', '0.35em')
                .attr('fill', 'white')
                .attr('font-size', '12px')
                .attr('font-weight', 'bold')
                .text('âŒ‚');

            // í‚¤ì›Œë“œ ì¶”ì¶œ í•¨ìˆ˜
            function extractKeywords(newsData) {
                const keywords = new Set();
                newsData.forEach(news => {
                    // ì œëª©ì—ì„œ í‚¤ì›Œë“œ ì¶”ì¶œ (ê°„ë‹¨í•œ ë°©ì‹)
                    const words = news.title.split(/[\s,.-]+/).filter(word => 
                        word.length > 1 && 
                        !['ê´€ë ¨', 'ëŒ€í•œ', 'ìœ„í•œ', 'í†µí•´', 'ë”°ë¥¸', 'ì˜í•´', 'ì—ì„œ', 'ì—ê²Œ', 'ìœ¼ë¡œ', 'ì—ëŠ”', 'ì—ë„', 'ë‰´ìŠ¤', 'ê¸°ì‚¬'].includes(word)
                    );
                    words.slice(0, 2).forEach(word => keywords.add(word)); // ìƒìœ„ 2ê°œ ë‹¨ì–´ë§Œ
                });
                return Array.from(keywords).slice(0, 8); // ìµœëŒ€ 8ê°œ í‚¤ì›Œë“œ
            }

            const keywords = extractKeywords(newsData);

            // ì¤‘ì‹¬ ë…¸ë“œ (ì´ì œ ë“œë˜ê·¸ ê°€ëŠ¥)
            const centerNode = {
                x: centerX,
                y: centerY,
                text: centerKeyword,
                type: 'center',
                radius: 45,
                id: 'center'
            };

            // í‚¤ì›Œë“œ ë…¸ë“œë“¤ì„ ì¤‘ê°„ ê±°ë¦¬ì— ë°°ì¹˜
            const keywordNodes = keywords.map((keyword, i) => {
                const angle = (i / keywords.length) * 2 * Math.PI;
                const radius = 100;
                
                return {
                    x: centerX + Math.cos(angle) * radius,
                    y: centerY + Math.sin(angle) * radius,
                    text: keyword,
                    type: 'keyword',
                    radius: 25,
                    id: `keyword-${i}`,
                    color: ['#ff9500', '#00d4ff', '#a855f7', '#00ff88', '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4'][i % 8]
                };
            });

            // ë‰´ìŠ¤ ë…¸ë“œë“¤ì„ ì™¸ê³½ì— ë°°ì¹˜í•˜ê³  ê´€ë ¨ í‚¤ì›Œë“œì™€ ì—°ê²°
            const newsNodes = newsData.map((news, i) => {
                const angle = (i / newsData.length) * 2 * Math.PI;
                const radius = 180 + Math.random() * 60;
                
                // ë‰´ìŠ¤ ì œëª©ì—ì„œ ê´€ë ¨ í‚¤ì›Œë“œ ì°¾ê¸°
                const relatedKeywords = keywords.filter(keyword => 
                    news.title.toLowerCase().includes(keyword.toLowerCase())
                );
                
                return {
                    x: centerX + Math.cos(angle) * radius,
                    y: centerY + Math.sin(angle) * radius,
                    text: news.title.length > 20 ? news.title.substring(0, 20) + '...' : news.title,
                    fullTitle: news.title,
                    url: news.url,
                    type: 'news',
                    credibility: news.credibility || 'Medium',
                    credibilityColor: getCredibilityColor(news.credibility || 'Medium'),
                    radius: 18,
                    id: `news-${i}`,
                    relatedKeywords: relatedKeywords,
                    publishedDate: news.publishedDate
                };
            });

            const allNodes = [centerNode, ...keywordNodes, ...newsNodes];

            // ë§í¬ ë°ì´í„° ìƒì„±
            const links = [];
            
            // ì¤‘ì‹¬ì—ì„œ í‚¤ì›Œë“œë¡œì˜ ë§í¬
            keywordNodes.forEach(keyword => {
                links.push({
                    source: centerNode,
                    target: keyword,
                    type: 'center-keyword'
                });
            });

            // í‚¤ì›Œë“œì—ì„œ ê´€ë ¨ ë‰´ìŠ¤ë¡œì˜ ë§í¬
            newsNodes.forEach(news => {
                if (news.relatedKeywords.length > 0) {
                    // ê°€ì¥ ê´€ë ¨ì„± ë†’ì€ í‚¤ì›Œë“œ í•˜ë‚˜ì™€ ì—°ê²°
                    const relatedKeyword = keywordNodes.find(k => 
                        news.relatedKeywords.includes(k.text)
                    );
                    if (relatedKeyword) {
                        links.push({
                            source: relatedKeyword,
                            target: news,
                            type: 'keyword-news'
                        });
                    }
                } else {
                    // ê´€ë ¨ í‚¤ì›Œë“œê°€ ì—†ìœ¼ë©´ ì¤‘ì‹¬ê³¼ ì§ì ‘ ì—°ê²°
                    links.push({
                        source: centerNode,
                        target: news,
                        type: 'center-news'
                    });
                }
            });

            // D3 ì‹œë®¬ë ˆì´ì…˜ ì„¤ì • (ê°œì„ ëœ ìƒí˜¸ì‘ìš©)
            const simulation = d3.forceSimulation(allNodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(d => {
                    if (d.type === 'center-keyword') return 90;
                    if (d.type === 'keyword-news') return 70;
                    return 110;
                }).strength(0.8)) // ë§í¬ ê°•ë„ ì¦ê°€
                .force('charge', d3.forceManyBody().strength(d => {
                    if (d.type === 'center') return -400;
                    if (d.type === 'keyword') return -250;
                    return -150;
                }))
                .force('center', d3.forceCenter(centerX, centerY).strength(0.1))
                .force('collision', d3.forceCollide().radius(d => d.radius + 10).strength(0.7))
                .alpha(0.5)
                .alphaDecay(0.02); // ë” ì²œì²œíˆ ì•ˆì •í™”

            // ë§í¬ ê·¸ë¦¬ê¸° (g ê·¸ë£¹ì— ì¶”ê°€)
            const linkElements = g.append('g')
                .selectAll('line')
                .data(links)
                .enter()
                .append('line')
                .attr('stroke', d => {
                    if (d.type === 'center-keyword') return '#ff006e';
                    if (d.type === 'keyword-news') return '#00ffff';
                    return '#888';
                })
                .attr('stroke-width', d => {
                    if (d.type === 'center-keyword') return 3;
                    return 2;
                })
                .attr('opacity', 0.6);

            // ë…¸ë“œ ê·¸ë£¹ ìƒì„± (g ê·¸ë£¹ì— ì¶”ê°€)
            const nodeElements = g.append('g')
                .selectAll('g')
                .data(allNodes)
                .enter()
                .append('g')
                .attr('class', 'node')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            // ì›í˜• ë…¸ë“œ
            nodeElements.append('circle')
                .attr('r', d => d.radius)
                .attr('fill', d => {
                    if (d.type === 'center') return '#ff006e';
                    if (d.type === 'keyword') return d.color;
                    return d.credibilityColor;
                })
                .attr('stroke', '#fff')
                .attr('stroke-width', d => d.type === 'center' ? 4 : 2)
                .style('filter', d => {
                    if (d.type === 'center') return 'drop-shadow(0 0 20px rgba(255, 0, 110, 0.8))';
                    if (d.type === 'keyword') return `drop-shadow(0 0 15px ${d.color}60)`;
                    return `drop-shadow(0 0 10px ${d.credibilityColor}60)`;
                })
                .style('cursor', 'grab')
                .on('click', function(event, d) {
                    if (d.type === 'news' && d.url) {
                        window.open(d.url, '_blank');
                    }
                })
                .on('mouseover', function(event, d) {
                    showTooltip(event, d);
                    d3.select(this).style('cursor', 'grab');
                })
                .on('mouseout', function() {
                    hideTooltip();
                });

            // í…ìŠ¤íŠ¸ ë ˆì´ë¸”
            nodeElements.append('text')
                .attr('text-anchor', 'middle')
                .attr('dy', '0.35em')
                .attr('fill', 'white')
                .attr('font-size', d => {
                    if (d.type === 'center') return '14px';
                    if (d.type === 'keyword') return '11px';
                    return '9px';
                })
                .attr('font-weight', d => d.type === 'center' ? 'bold' : 'normal')
                .text(d => d.text)
                .style('pointer-events', 'none')
                .style('user-select', 'none');

            // ì‹œë®¬ë ˆì´ì…˜ í‹± ì´ë²¤íŠ¸
            simulation.on('tick', () => {
                // ë…¸ë“œë“¤ì´ SVG ê²½ê³„ë¥¼ ë²—ì–´ë‚˜ì§€ ì•Šë„ë¡ ì œí•œ
                allNodes.forEach(d => {
                    d.x = Math.max(d.radius, Math.min(width - d.radius, d.x));
                    d.y = Math.max(d.radius, Math.min(height - d.radius, d.y));
                });

                // ë§í¬ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
                linkElements
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);

                // ë…¸ë“œ ìœ„ì¹˜ ì—…ë°ì´íŠ¸
                nodeElements
                    .attr('transform', d => `translate(${d.x}, ${d.y})`);
            });

            // ê°œì„ ëœ ë“œë˜ê·¸ í•¨ìˆ˜ë“¤
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.5).restart();
                
                // ë“œë˜ê·¸ë˜ëŠ” ë…¸ë“œ ê³ ì •
                d.fx = d.x;
                d.fy = d.y;
                
                // ì—°ê²°ëœ ë…¸ë“œë“¤ë„ í•¨ê»˜ ì›€ì§ì´ë„ë¡ ì„¤ì •
                if (d.type === 'center') {
                    // ì¤‘ì‹¬ ë…¸ë“œë¥¼ ë“œë˜ê·¸í•˜ë©´ í‚¤ì›Œë“œ ë…¸ë“œë“¤ë„ í•¨ê»˜
                    keywordNodes.forEach(keyword => {
                        keyword.fx = keyword.x;
                        keyword.fy = keyword.y;
                    });
                } else if (d.type === 'keyword') {
                    // í‚¤ì›Œë“œ ë…¸ë“œë¥¼ ë“œë˜ê·¸í•˜ë©´ ì—°ê²°ëœ ë‰´ìŠ¤ ë…¸ë“œë“¤ë„ í•¨ê»˜
                    const connectedNews = newsNodes.filter(news => 
                        news.relatedKeywords.includes(d.text)
                    );
                    connectedNews.forEach(news => {
                        news.fx = news.x;
                        news.fy = news.y;
                    });
                }
                
                d3.select(this).style('cursor', 'grabbing');
            }

            function dragged(event, d) {
                const dx = event.x - d.x;
                const dy = event.y - d.y;
                
                // ë“œë˜ê·¸ë˜ëŠ” ë…¸ë“œ ì´ë™
                d.fx = event.x;
                d.fy = event.y;
                
                // ì—°ê²°ëœ ë…¸ë“œë“¤ë„ í•¨ê»˜ ì´ë™
                if (d.type === 'center') {
                    keywordNodes.forEach(keyword => {
                        if (keyword.fx !== null) {
                            keyword.fx += dx * 0.3; // 30% ì •ë„ë§Œ ë”°ë¼ì›€ì§ì„
                            keyword.fy += dy * 0.3;
                        }
                    });
                } else if (d.type === 'keyword') {
                    const connectedNews = newsNodes.filter(news => 
                        news.relatedKeywords.includes(d.text)
                    );
                    connectedNews.forEach(news => {
                        if (news.fx !== null) {
                            news.fx += dx * 0.5; // 50% ì •ë„ ë”°ë¼ì›€ì§ì„
                            news.fy += dy * 0.5;
                        }
                    });
                }
            }

            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                
                // ëª¨ë“  ë…¸ë“œì˜ ê³ ì • í•´ì œ (ìì—°ìŠ¤ëŸ¬ìš´ ì›€ì§ì„ì„ ìœ„í•´)
                setTimeout(() => {
                    allNodes.forEach(node => {
                        node.fx = null;
                        node.fy = null;
                    });
                }, 500); // 0.5ì´ˆ í›„ í•´ì œ
                
                d3.select(this).style('cursor', 'grab');
            }

            // íˆ´íŒ í•¨ìˆ˜ë“¤
            function showTooltip(event, d) {
                let tooltipContent = '';
                
                if (d.type === 'center') {
                    tooltipContent = `<strong>ğŸ¯ ê²€ìƒ‰ í‚¤ì›Œë“œ</strong><br>${d.text}`;
                } else if (d.type === 'keyword') {
                    tooltipContent = `<strong>ğŸ”‘ ê´€ë ¨ í‚¤ì›Œë“œ</strong><br>${d.text}`;
                } else if (d.type === 'news') {
                    tooltipContent = `
                        <strong>${d.fullTitle}</strong><br>
                        <span style="color: ${d.credibilityColor}">ì‹ ë¢°ë„: ${d.credibility}</span><br>
                        ${d.publishedDate ? `ğŸ“… ${d.publishedDate}` : 'ğŸ“… ë‚ ì§œ ë¯¸ìƒ'}<br>
                        <small>í´ë¦­í•˜ì—¬ ê¸°ì‚¬ ë³´ê¸°</small>
                    `;
                }

                const tooltip = d3.select('body').append('div')
                    .attr('class', 'mindmap-tooltip')
                    .style('position', 'absolute')
                    .style('background', 'rgba(0, 0, 0, 0.9)')
                    .style('color', 'white')
                    .style('padding', '10px')
                    .style('border-radius', '5px')
                    .style('pointer-events', 'none')
                    .style('font-size', '12px')
                    .style('max-width', '200px')
                    .style('z-index', '1000')
                    .style('left', (event.pageX + 10) + 'px')
                    .style('top', (event.pageY - 10) + 'px')
                    .html(tooltipContent);
            }

            function hideTooltip() {
                d3.selectAll('.mindmap-tooltip').remove();
            }

            // ì‚¬ìš©ë²• ì•ˆë‚´ ì¶”ê°€
            const instructions = svg.append('g')
                .attr('class', 'instructions')
                .attr('transform', 'translate(10, 20)');

            instructions.append('text')
                .attr('fill', 'rgba(255, 255, 255, 0.7)')
                .attr('font-size', '12px')
                .text('ğŸ’¡ ë§ˆìš°ìŠ¤ íœ ë¡œ í™•ëŒ€/ì¶•ì†Œ, ë“œë˜ê·¸ë¡œ ì´ë™, ìš°ì¸¡ ë²„íŠ¼ìœ¼ë¡œ ì¡°ì‘');
        }

        // ì‹œê°„ëŒ€ë³„ ë‰´ìŠ¤ í‘œ ìƒì„± (ë‚ ì§œ í‘œì‹œ ê°œì„ )
        function createTimeline(newsData) {
            const container = d3.select('#timeline');
            container.selectAll('*').remove();

            // ë‰´ìŠ¤ë¥¼ ë‚ ì§œë³„ë¡œ ê·¸ë£¹í™” (publishedDate ì‚¬ìš©)
            const newsByDate = {};
            newsData.forEach(news => {
                let date = 'ë‚ ì§œ ë¯¸ìƒ';
                if (news.publishedDate) {
                    // ë‚ ì§œ í˜•ì‹ ì •ê·œí™”
                    try {
                        const dateObj = new Date(news.publishedDate);
                        if (!isNaN(dateObj.getTime())) {
                            date = dateObj.toLocaleDateString('ko-KR');
                        }
                    } catch (e) {
                        console.log('ë‚ ì§œ íŒŒì‹± ì˜¤ë¥˜:', news.publishedDate);
                    }
                } else if (news.publishedAt) {
                    // publishedAtë„ í™•ì¸
                    try {
                        const dateObj = new Date(news.publishedAt);
                        if (!isNaN(dateObj.getTime())) {
                            date = dateObj.toLocaleDateString('ko-KR');
                        }
                    } catch (e) {
                        console.log('ë‚ ì§œ íŒŒì‹± ì˜¤ë¥˜:', news.publishedAt);
                    }
                }
                
                if (!newsByDate[date]) {
                    newsByDate[date] = [];
                }
                newsByDate[date].push(news);
            });

            console.log('ğŸ“… ë‚ ì§œë³„ ë‰´ìŠ¤ ê·¸ë£¹:', newsByDate);

            // ë‚ ì§œìˆœìœ¼ë¡œ ì •ë ¬ (ì˜¤ë¦„ì°¨ìˆœ - ì˜¤ë˜ëœ ê¸°ì‚¬ë¶€í„°)
            const sortedDates = Object.keys(newsByDate).sort((a, b) => {
                if (a === 'ë‚ ì§œ ë¯¸ìƒ') return 1;
                if (b === 'ë‚ ì§œ ë¯¸ìƒ') return -1;
                
                try {
                    const dateA = new Date(a.split('.').reverse().join('-'));
                    const dateB = new Date(b.split('.').reverse().join('-'));
                    return dateA - dateB; // ì˜¤ë¦„ì°¨ìˆœ (ì˜¤ë˜ëœ ìˆœ)
                } catch (e) {
                    return 0;
                }
            });

            // í‘œ ìƒì„±
            const table = container.append('table');

            // í—¤ë”
            const header = table.append('thead').append('tr');
            header.append('th').text('ğŸ“… ë°œí–‰ì¼').style('width', '120px');
            header.append('th').text('ğŸ“° ë‰´ìŠ¤ ì œëª©');
            header.append('th').text('ğŸ¯ ì‹ ë¢°ë„').style('width', '100px').style('text-align', 'center');

            // ë°”ë””
            const tbody = table.append('tbody');

            sortedDates.forEach(date => {
                const newsForDate = newsByDate[date];
                
                newsForDate.forEach((news, newsIndex) => {
                    const row = tbody.append('tr')
                        .style('cursor', news.url ? 'pointer' : 'default')
                        .on('click', function() {
                            if (news.url) {
                                window.open(news.url, '_blank');
                            }
                        });

                    // ë‚ ì§œ ì…€ (ì²« ë²ˆì§¸ ë‰´ìŠ¤ì—ë§Œ í‘œì‹œ)
                    if (newsIndex === 0) {
                        row.append('td')
                            .text(date)
                            .style('color', date === 'ë‚ ì§œ ë¯¸ìƒ' ? '#ffaa00' : '#00ffff')
                            .style('font-weight', 'bold')
                            .style('vertical-align', 'top')
                            .style('border-right', '2px solid rgba(255, 255, 255, 0.2)')
                            .attr('rowspan', newsForDate.length);
                    }

                    // ì œëª© ì…€
                    row.append('td')
                        .text(news.title)
                        .style('padding-left', '15px');

                    // ì‹ ë¢°ë„ ì…€
                    row.append('td')
                        .text(news.credibility || 'Medium')
                        .style('color', getCredibilityColor(news.credibility || 'Medium'))
                        .style('font-weight', 'bold')
                        .style('text-align', 'center');
                });
            });

            // í†µê³„ ì •ë³´ ì¶”ê°€
            const statsDiv = container.append('div')
                .style('margin-top', '15px')
                .style('padding', '10px')
                .style('background', 'rgba(255, 255, 255, 0.1)')
                .style('border-radius', '8px')
                .style('font-size', '14px');

            const totalNews = newsData.length;
            const datesWithNews = sortedDates.filter(date => date !== 'ë‚ ì§œ ë¯¸ìƒ').length;
            const unknownDateNews = newsByDate['ë‚ ì§œ ë¯¸ìƒ'] ? newsByDate['ë‚ ì§œ ë¯¸ìƒ'].length : 0;

            statsDiv.html(`
                <strong>ğŸ“Š í†µê³„ ì •ë³´</strong><br>
                â€¢ ì´ ë‰´ìŠ¤ ê°œìˆ˜: ${totalNews}ê°œ<br>
                â€¢ ë‚ ì§œ í™•ì¸ëœ ë‰´ìŠ¤: ${totalNews - unknownDateNews}ê°œ<br>
                â€¢ ë°œí–‰ì¼ ë²”ìœ„: ${datesWithNews}ì¼ê°„<br>
                ${unknownDateNews > 0 ? `â€¢ ë‚ ì§œ ë¯¸ìƒ: ${unknownDateNews}ê°œ` : ''}
            `);
        }

        // AI ë¶„ì„ ê²°ê³¼ í‘œì‹œ
        function displayAnalysis(analysis) {
            const analysisDiv = document.getElementById('analysis');
            analysisDiv.innerHTML = `
                <div style="line-height: 1.6;">
                    <p><strong>ğŸ“Š ì¢…í•© ë¶„ì„:</strong></p>
                    <p>${analysis.summary || 'ë¶„ì„ ê²°ê³¼ë¥¼ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.'}</p>
                    
                    <p style="margin-top: 15px;"><strong>ğŸ” ì£¼ìš” ë°œê²¬ì‚¬í•­:</strong></p>
                    <ul style="margin-left: 20px;">
                        ${analysis.keyFindings ? analysis.keyFindings.map(finding => `<li>${finding}</li>`).join('') : '<li>ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤.</li>'}
                    </ul>
                    
                    <p style="margin-top: 15px;"><strong>ğŸ’¡ ê¶Œì¥ì‚¬í•­:</strong></p>
                    <p>${analysis.recommendation || 'ì¶”ê°€ ê²€ì¦ì„ ê¶Œì¥í•©ë‹ˆë‹¤.'}</p>
                </div>
            `;
        }

        // ì‹ ë¢°ë„ì— ë”°ë¥¸ ìƒ‰ìƒ ë°˜í™˜
        function getCredibilityColor(credibility) {
            const colors = {
                'High': '#00ff88',
                'Medium': '#ffaa00',
                'Low': '#ff4444'
            };
            return colors[credibility] || colors['Medium'];
        }

        // ë¡œë”© í‘œì‹œ/ìˆ¨ê¹€
        function showLoading(show) {
            loading.style.display = show ? 'block' : 'none';
            if (show) {
                results.style.display = 'none';
            }
        }

        // ì—ëŸ¬ í‘œì‹œ
        function showError(message) {
            error.textContent = message;
            error.style.display = 'block';
        }

        // ì—ëŸ¬ ìˆ¨ê¹€
        function hideError() {
            error.style.display = 'none';
        }

        console.log('âœ… JavaScript ë¡œë“œ ì™„ë£Œ');
    </script>
</body>
</html>
